{% extends "layout.html" %}
{% block javascript %}
    {{ super() }}
    <script type="text/javascript">

        var stations = [];
        var accordion_options = { heightStyle: "content" };

        var proj3857 = new OpenLayers.Projection("EPSG:3857");
        var proj4326 = new OpenLayers.Projection("EPSG:4326");
        var map;
        var features = [];
        var selectCtl;

        function buildAlertHeader(alert) {

            var del_link =  $("<a />")
                                .html("Delete")
                                .attr("class","alert_delete")
                                .attr("href", alert.destroy_url)
                                .on("click", function(e) {
                                    e.preventDefault();
                                    $.post(alert.destroy_url
                                        ,null
                                        ,function() {
                                            var parent = $(e.currentTarget).closest('h3');
                                            var head = parent.next('div');
                                            head.add(parent).fadeOut('slow',function(){ $(e.currentTarget).remove(); });
                                            $( "#alerts" ).accordion( "refresh" );
                                        });
                                    return false;
                                });

            return $("<h3 />").append($("<span />").html(alert.name))
                              .append(del_link)
                              .append("<br />")
                              .append($("<span />").attr('class','last_text').html("Last checked: " + alert.checked))
                              .append("<br />")
                              .append($("<span />").attr('class','last_text').html("Last notification sent: " + alert.sent))
                              .append("<br />")
                              .append($("<span />").attr('class','last_text').html("Notification of alert every: " + alert.frequency));
        }

        function buildAlertContents(alert) {

            var content = $("<div />");  

            // Add conditions
            var ul = $("<ul />")
            // this matches conditions with the correct station and lists them
            // under the station headings.  this is ugly.
            var last_station_id = null;
            var last_station_dom = null;            
            for (var j = 0 ; j < alert.conditions.length ; j++) {
                var this_station_id = alert.conditions[j].station_id;

                if (this_station_id != last_station_id) {
                    // Add the last station
                    ul.append(last_station_dom);

                    // Build station section
                    last_station_dom = buildStationHeading(this_station_id);
                    last_station_id = this_station_id;
                }

                last_station_dom.append(buildCondition(alert.conditions[j]));
            }
            ul.append(last_station_dom);

            // Add the "Add new condition" form
            ul.append(buildAddCondition(alert));

            content.append(ul);

            return content;
        }

        function buildStationHeading(station_id) {
            station = findStationById(station_id);
            var d = $('<li />').attr('id', station_id);             

            // If there is a station link, create the link
            if (station.link != "") {
                d.append($("<a />")
                // SHOES changed this link from station home page to zoomToStation on map
                .attr("href","javascript:zoomToStationById('" + station_id + "')")
/*
                .attr("href", station.link)
                .attr("target", "_blank")
*/
                .html(station.provider + " - " + station.description))
            } else {
                d.append($("<span />").html(station.provider + " - " + station.description));
            }

            return d
        }

        function buildCondition(cond) {

            data = cond['timeseries'];

            var root = $('<div />');

            root.append($("<span />").html(cond.variable + " (" + cond.units + ") " + cond.comparator + " " + cond.value));
            
            var linechart = $("<span />");
            if (data.length > 0) {
                linechart.sparkline(data, {
                    type: 'line',
                    width: '150',
                    height: '30',
                    lineColor: '#0000f0',
                    fillColor: '#c0d0f0',
                    spotRadius: 0,
                    lineWidth: 1,
                });
            }
            linechart.css("width", "150px").html(" - No recent data - ")

            root.append(linechart);

            root.append($("<button />")
                            .html("Delete")
                            .on("click", function(e) {
                                e.preventDefault();
                                $.post(cond.destroy_url
                                    ,null
                                    ,function() {
                                        var station_div = $(e.currentTarget).parent().parent();
                                        // Remove condition that was clicked
                                        $(e.currentTarget).parent().remove();
                                        // Remove station heading if there are no more conditions
                                        if (station_div.find("div").length == 0) {
                                            station_div.remove();
                                        }
                                        $( "#alerts" ).accordion( "refresh" );
                                    }
                                )})
                        );

            return root;
        }

        function findStationByIndex(index) {
            return stations[index];
        }

        function findStationById(id) {
            for (var i = 0 ; i < stations.length ; i++) {
                if (stations[i]._id == id) {
                    return stations[i];
                }
            }
            return null;
        }

        function buildStationSelect(click_callback) {

            var stat = $().add($("<select />")
                                .attr("name", "station")
                                .on("change", function(e) { click_callback(e); }));

            // Set value to the index into the station array
            $.each(stations, function(i,s) {
                stat.append($("<option />")
                                .attr("value", s._id)
                                .html(s.provider + " - " + s.description));
            });

            return stat;
        }

        function buildAddCondition(alert) {

            // Create form
            var root = $("<form />").attr("name", alert._id).append($("<span />").html("Add condition: "))

            // Add station select
            root.append(buildStationSelect(function(clicker) {
                target = $(clicker.currentTarget);
                station = findStationById(target.val());

                var_select = target.parent().find("select[name=variable]");
                var_select.empty();

                if (station.variables.length < 1) {
                    variable.append($("<option />")
                                        .attr("value", "")
                                        .html("Station not reporting, please check back at a later time to add more alerts"));
                    target.parent().find("button[name=add]").attr("disabled", "disabled");
                } else {
                    $.each(station.variables, function(k,v) {
                        var_select.append($("<option />")
                                            .attr("value", k)
                                            .html(k));
                    });
                    var_select.on("change", function(e) {
                                                t = $(e.currentTarget);
                                                units_select = t.parent().find("select[name=units]");
                                                units_select.empty();
                                                $.each(station.variables[t.val()], function(i, u) {
                                                    units_select.append($("<option />")
                                                        .attr("value", u)
                                                        .html(u));
                                                });
                                            });
                    var_select.trigger("change");
                    target.parent().find("button[name=add]").removeAttr("disabled");
                }
                
            }));

            root.append($("<select />")
                            .attr("name", "variable"));

            root.append($("<select />")
                            .attr("name", "units"));

            root.append($("<select />")
                            .attr("name", "comparator")
                            .append($("<option />")
                                .attr("value", "<=")
                                .html("<="))
                            .append($("<option />")
                                .attr("value", ">=")
                                .html(">="))
                            .append($("<option />")
                                .attr("value", "=")
                                .html("=")));

            root.append($("<input />")
                            .attr("name", "value")
                            .attr("type", "textfield"));

            root.append($("<button />")
                            .attr("name", "add")
                            .attr("id", alert._id)
                            .html("Add")
                            .on("click", function(e) {
                                e.preventDefault();
                                var link =  $(this);
                                $.post(alert.new_condition_url
                                    ,$("form[name=" + link.attr("id") + "]").serialize()
                                    ,function(condition) {
                                        if (condition["error"]) {
                                            $("#messages").html("<div class='flash'>" + condition["error"] + "</div>");
                                        } else {
                                            var station_dom = $("form[name=" + link.attr("id") + "]").parent().find("#" + condition.station_id);
                                            if (station_dom.length == 0) {
                                                station_dom = buildStationHeading(condition.station_id);
                                                $("form[name=" + link.attr("id") + "]").before(station_dom);
                                            }
                                            station_dom.append(buildCondition(condition));
                                        }
                                        $.sparkline_display_visible();
                                        $( "#alerts" ).accordion( "refresh" );
                                    }
                                )})
                            );

            return root;
        }

        function addAlert(alert) {
            if (alert["error"]) {
               $("#messages").html("<div class='flash'>" + alert["error"] + "</div>");
            } else {
                $(buildAlertHeader(alert)).appendTo("#alerts");
                $(buildAlertContents(alert)).appendTo("#alerts");
                $( "#alerts" ).accordion( "refresh" );

                $("#alerts").find("select[name=station]").trigger("change");
                $.sparkline_display_visible();
            }
        }

        function popup(f,showSensors) {
          var station = findStationById(f.cluster ? f.cluster[0].attributes._id : f.attributes._id);
          var rows = [];
          var timeFound;
          if (showSensors) {
            for (var obsName in station.last_obs) {
              if (!timeFound) {
                timeFound = true;
                rows.unshift('<td colspan=2>' + new Date(station.last_obs[obsName].t * 1000).format("mmm d h:MM TT Z") + '</td>');
              }
              var obsVals = [];
              for (var obsUnit in station.last_obs[obsName].v) {
                obsVals.push(String(station.last_obs[obsName].v[obsUnit] + ' ' + obsUnit).replace(/ /g,'&nbsp;'));
              }
              if (obsVals.length == 0) {
                obsVals = ['---'];
              }
              var alertImg = '{{ url_for('.static', filename='images/blank.png') }}';
              // SHOES this is where you would test for the alert activity
              if (rows.length % 2 == 0) {
                alertImg = '{{ url_for('.static', filename='images/alert16.png') }}';
              }
              rows.push(
                '<td align=left><a href="javascript:gotoCondition(\'' + station._id + '\',\'' + obsName + '\')">' + obsName + '</a></td>' 
                + '<td align=right>' + obsVals.join('<br>') + '</td>'
                + '<td><img width=16 height=16 src="' + alertImg + '"></td>'
              );
            }
            rows.push('<td colspan=2 align=center><font color=gray>Click on a sensor link to access alert settings.</font></td>');
          }
          else {
            rows.push('<td align=center><font color=gray>Click the icon to view sensor details.</font></td>');
          }
          rows.unshift('<th colspan=2>' + station.provider + ' - ' + station.description + '</th>');
          var centroid = f.geometry.getCentroid();
          map.popup = new OpenLayers.Popup.FramedCloud(
             'popup'
            ,new OpenLayers.LonLat(centroid.x,centroid.y)
            ,null
            ,'<table class="buoyPopup"><tr>' + rows.join('</tr><tr>') + '</tr></table>'
            ,null
            ,showSensors
            ,function() {
              map.removePopup(map.popup);
              map.popup.destroy();
              delete map.popup;
            }
          );
          map.popup.panMapIfOutOfView = false;
          map.popup.name = f.attributes.name;
          map.addPopup(map.popup,true);
          map.popup.setSize(map.popup.contentSize);
        }

        function recenterAndZoomToFeature(f) {
          var centroid = f.geometry.getCentroid();
          map.setCenter(new OpenLayers.LonLat(centroid.x,centroid.y),map.getZoom() + 1);
          if (map.popup) {
            map.removePopup(map.popup);
            map.popup.destroy();
            delete map.popup;
          }
        }

        function zoomToStationById(id) {
          var lyr = map.getLayersByName('Stations')[0];
          var f = lyr.features;
          for (var i = 0 ; i < f.length; i++) {
            for (var j = 0 ; j < f[i].cluster.length; j++) {
              if (f[i].cluster[j].attributes._id == id) {
                f[i].cluster[j].attributes.force = 1;
                var centroid = f[i].geometry.getCentroid();
                map.setCenter(new OpenLayers.LonLat(centroid.x,centroid.y),8);
                popup(f[i],true);
                return;
              }
            }
          }
        }

        function gotoCondition(station_id,sensorName) {
          // SHOES do something w/ this
          alert('WTF do I do w/ station ' + station_id + '\'s ' + sensorName + ' sensor?');
        }

        function syncMapWithAlert(alert) {
          var lyr = map.getLayersByName('Stations')[0];
          lyr.removeFeatures();
          for (var i = 0; i < features.length; i++) {
            features[i].attributes.numAlertsWatched   = 0;
            features[i].attributes.numAlertsTriggered = 0;
            features[i].attributes.force              = 0;
            for (var k = 0 ; k < alert.conditions.length ; k++) {
              if (features[i].attributes._id == alert.conditions[k].station_id) {
                features[i].attributes.numAlertsWatched++;
                // SHOES need to do the real testing here
                features[i].attributes.numAlertsTriggered += (k == 1 || k % 2 == 0) ? 1 : 0;
              }
            }
          } 
          lyr.addFeatures(features);
          lyr.redraw();
        }

        $(document).ready(function() {
            {%- if session.get('user_email', None) -%}

                var lyr = new OpenLayers.Layer.Vector(
                   'Stations'
                  ,{
                    styleMap : new OpenLayers.StyleMap({
                      'default': new OpenLayers.Style({
                           graphicZIndex   : "${getGraphicZIndex}"
                          ,externalGraphic : "${getExternalGraphic}"
                          ,graphicOpacity  : 1
                          ,graphicWidth    : "${getGraphicWidthHeight}"
                          ,graphicHeight   : "${getGraphicWidthHeight}"
                          ,pointRadius     : "${getPointRadius}"
                      }, {
                          context: {
                              getGraphicZIndex : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          return 10;
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return 5;
                                      }
                                      else {
                                          return 7;
                                      }
                                  }
                                  return 1;
                              }
                              ,getExternalGraphic : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          if (feature.cluster[0].attributes.numAlertsTriggered - feature.cluster[0].attributes.numAlertsWatched == 0) {
                                              return '{{ url_for('.static', filename='images/traffic-red32.png') }}';
                                          }
                                          else {
                                              return '{{ url_for('.static', filename='images/traffic-yellow32.png') }}';
                                          }
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return '{{ url_for('.static', filename='images/traffic-green32.png') }}';
                                      }
                                      else {
                                          return '{{ url_for('.static', filename='images/site20.png') }}';
                                      }
                                  }
                                  else {
                                      return '{{ url_for('.static', filename='images/magnifier16.png') }}';
                                  }
                              }
                              ,getGraphicWidthHeight : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          return 32; 
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return 32;
                                      }
                                      else {
                                          return 20;
                                      }
                                  }
                                  return 16;
                              }
                              ,getPointRadius : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          return 32 / 2;
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return 32 / 2;
                                      }
                                      else {
                                          return 20 / 2;
                                      }
                                  }
                                  return 16 / 2;
                              }
                          }
                      })
                    })
                    ,strategies : [new OpenLayers.Strategy.Cluster({
                      rule: new OpenLayers.Rule({
                          filter: new OpenLayers.Filter.Logical({
                            type    : OpenLayers.Filter.Logical.AND
                           ,filters : [
                              new OpenLayers.Filter.Comparison({
                                   type     : OpenLayers.Filter.Comparison.EQUAL_TO
                                  ,property : 'numAlertsWatched'
                                  ,value    : 0
                              })
                              ,new OpenLayers.Filter.Comparison({
                                   type     : OpenLayers.Filter.Comparison.NOT_EQUAL_TO
                                  ,property : 'force'
                                  ,value    : 1
                              })
                            ]
                          })
                      })
                      ,shouldCluster: function(cluster, feature) {
                          var superProto = OpenLayers.Strategy.Cluster.prototype;
                          return this.rule.evaluate(cluster.cluster[0]) &&
                                 this.rule.evaluate(feature) &&
                                 superProto.shouldCluster.apply(this,arguments);
                      }
                    })]
                    ,rendererOptions: {zIndexing: true}
                  }
                );
                selectCtl = new OpenLayers.Control.SelectFeature(
                   lyr
                  ,{
                     autoActivate   : true
                    ,eventListeners : {
                      featurehighlighted : function(e) {
                        if (e.feature.attributes.count == 1) {
                          popup(e.feature,true);
                        }
                        else {
                          recenterAndZoomToFeature(e.feature);
                        }
                      }
                    }
                  }
                );
                map = new OpenLayers.Map('map',{
                    layers             : [
                        new OpenLayers.Layer.XYZ(
                             'ESRI Ocean'
                            ,'http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/${z}/${y}/${x}.jpg'
                            ,{
                                 sphericalMercator : true
                                ,isBaseLayer       : true
                            }
                        )
                        ,lyr
                    ]
                    ,projection        : proj3857
                    ,displayProjection : proj4326
                    ,units             : 'm'
                    ,maxExtent         : new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508.34)
                });
                map.addControl(selectCtl);
                map.setCenter(new OpenLayers.LonLat(-84.4,44.0).transform(proj4326,proj3857),6);

                $( "#alerts" ).accordion(accordion_options);

                // Get stations
                $.get("{{ url_for('stations') }}", function(ss) {
                    var allStations  = ss["stations"];
                    var stations2ids = {};
                    // filter out stations outside our AOI
                    var aoi = new OpenLayers.Format.GeoJSON().read(getAOI())[0].geometry.transform(proj4326,proj3857);
                    for (var i = 0 ; i < allStations.length ; i++) {
                        var f = new OpenLayers.Feature.Vector(
                          new OpenLayers.Geometry.Point(
                             allStations[i].coordinates[1]
                            ,allStations[i].coordinates[0]
                          ).transform(proj4326,proj3857)
                          ,{
                             _id                : allStations[i]._id
                            ,numAlertsWatched   : 0
                            ,numAlertsTriggered : 0
                            ,force              : 0
                          }
                        );
                        if (aoi.intersects(f.geometry)) {
                          features.push(f);
                          stations2ids[allStations[i].provider + ' - ' + allStations[i].description] = allStations[i]._id;
                          stations.push(allStations[i]);
                        }
                    }

                    var sortedStations = [];
                    for (var s in stations2ids) {
                      sortedStations.push(s);
                    }
                    sortedStations.sort(function(a,b) {
                      return a.toLowerCase().localeCompare(b.toLowerCase());
                    });
                    var searchStations = [];
                    for (var i = 0; i < sortedStations.length; i++) {
                      searchStations.push({label : sortedStations[i],id : stations2ids[sortedStations[i]]});
                    }

                    $("#search").autocomplete({
                       source    : searchStations
                      ,select    : function(e,ui) {
                        zoomToStationById(ui.item.id);
                      }
                      ,minLength : 0
                    }).focus(function() {
                      $(this).autocomplete('search',$(this).val());
                    });

                    $.get("{{ url_for('alerts') }}", function(alerts) {
                        alerts = alerts["alerts"];
                        for (var i = 0 ; i < alerts.length ; i++) {
                            $(buildAlertHeader(alerts[i])).appendTo("#alerts");
                            $(buildAlertContents(alerts[i])).appendTo("#alerts");

                            $("#alerts").find("select[name=station]").trigger("change");
                            $.sparkline_display_visible();
                        }

                        $( "#alerts" ).accordion( "refresh" );
                        syncMapWithAlert(alerts[0]);
                    });
                });

                $("#alert_create_button").click(function() {
                    $.post("{{ url_for('new_alert') }}", 
                        $("#alert_form").serialize(),
                        function(alert) {
                            addAlert(alert);
                        }
                    );
                });

            {%- endif -%}
        });
    </script>
{% endblock %}
{% block page %}

    {%- if session.get('user_email', None) -%}

        <div id='left_notes'>
            <form id="alert_form">
                <label for="name">Name</label>
                <input type="textfield" id="name" name="name" />
                <label for="frequency">Notify me of alerts every</label>
                <select type="select" id="frequency" name="frequency">
                    <option value="10">10 minutes</option>
                    <option value="20">20 minutes</option>
                    <option value="40">40 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="360">6 hours</option>
                    <option value="720">12 hours</option>
                    <option value="1440">1 day</option>
                </select>
            </form>            
            <button name="alert_create_button" id="alert_create_button">Create Alert</button>
        </div>
        <div id='right_notes'>
            <div>Signed in as {{ session.get('user_email') }}</div>
            <a href="{{ url_for('logout') }}">sign out</a>
        </div>

        <div class='clear'></div>

        <h2>Alerts</h2>
        <div id="alerts"></div>
        <div id='map_wrapper'>
            <div id="searchDiv">Search for a station: <input id="search"></div>
            <div id="map"></div>
        </div>
        <div class="clear"></div>

    {%- else -%}

        <div id='welcome'>
            <h2>WELCOME!</h2>
            <p>
                GLOS Alerts allows you to create alerts with different variables related to the water temperature, salinity, wave height and direction. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
            </p>

            <div id='logins'>
                <a href="{{ url_for('login_google') }}">
                    <img src="{{ url_for('.static', filename='images/google.png') }}" />
                    <span>Login using your google account</span>
                </a>
                <a href="{{ url_for('login_facebook') }}">
                    <img src="{{ url_for('.static', filename='images/facebook.png') }}" />
                    <span>Login using your facebook account</span>
                </a>
            </div>

        </div>

    {%- endif -%}

{% endblock %}
